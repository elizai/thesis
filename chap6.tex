\chapter{Detalii de implementare}

\section{Structura de directoare}

Aplicația, la nivelul cel mai înalt, are 3 module Python (interpretorul
Python directoarele ce conțin fișierul gol \texttt{\_\_init\_\_.py} ca
fiind module):
\begin{description}
\item [authentication] este modulul responsabil înregistrare și autentificarea
utilizatorilor. Acest modul conține modelul ORM al utilizatorului și
view-urile REST corespunzătoare creării de utilizatori noi și
autentificării unui utilizator.
\item [expenses] este modulul ce conține modelul ORM al unuei cheltuieli
și view-urile REST corespunzătoare operațiilor CRUD asupra
cheltuielilor.
\item [money\_keep] este modulul responsabil de configurarea aplicației.
Conține, printre altele, fișierul de configurare \texttt{settings.py}
și fișierul ce conține toate rutele aplicației (URL-urile la 
care aplicația răspunde), \texttt{urls.py}.
\end{description}

Pe lângă aceste module, la nivelul cel mai înalt al aplicației
mai sunt directoarele:

\begin{description}
\item [static] conține toate resursele statice: 
  \begin{itemize}
  \item componentele instalate cu \emph{Bower}
  \item CSS-urile customizate ale aplicației
  \item întreaga aplicație AngularJS, cu toate șabloanele,
  controllerele, directivele și serviciile ei.
  \end{itemize}
\item [templates] conține șabloanele Django. Ele sunt scrise
folosind sintaxa \emph{Django Template Language} (DTL) și nu trebuie confundate
cu șabloanele din directorul "static/templates". Șabloanele din
acest director sunt folosite de Django, iar cele din "static" sunt
folosite de AngularJS.
\end{description}

\begin{lstlisting}[title=Structura de directoare a aplicației]
|-- authentication
|   |--- migrations
|-- expenses
|   |--- migrations
|-- money_keep
|-- static
|   |-- bower_components
|   |-- css
|   |-- js
|   |   |-- authentication
|   |   |   |-- controllers
|   |   |   |--- services
|   |   |-- expenses
|   |   |   |-- controllers
|   |   |   |-- directives
|   |   |   |--- services
|   |   |-- layout
|   |   |   |--- controllers
|   |   |--- utils
|   |       |-- controllers
|   |       |--- services
|   |--- templates
|       |-- authentication
|       |-- expenses
|       |-- layout
|       |--- utils
|--- templates
\end{lstlisting}


\section{Module AngularJS}

Pe partea de front-end, aplicația este structurată
în următoarele module:
\begin{description}
\item [authentication] este modulul responsabil de autentificare.
Acest modul conține serviciul \emph{Authentication} care are metodele
pentru autentificare, logout și verificarea dacă utilizatorul este
autentificat.
\item [expenses] este modulul responsabil de operațiile
CRUD pentru o cheltuială. Pe lângă serviciul care are apelează
metodele REST ale back-end-ului, în acest modul sunt definite și directivele
AngularJS \emph{expense} și \emph{expenses}. Aceste directive
fac posibilă folosirea în șabloane AngularJS a elementelor HTML
\texttt{<expense>} și \texttt{<expenses>}.
\item [layout] este modulul care conține logica de filtrare / căutare
a cheltuielilor și leagă butoanele din bara de navigare de funcționalitatea
acestora.
\item [utils] este un modul care conține logica de printare
precum și un serviciu utilitar ce se ocupă cu prelucrarea
obiectelor date / time.
\end{description} 

\section{API REST}

Deoarece front-end-ul aplicației este scris cu AngularJS,
comunicarea dintre front-end și back-end se face
prin intermediul unui API REST. Acest API REST a fost
creat cu ajutorul unui plugin Django: 
\emph{Django REST Framework}\footnote{\url{http://www.django-rest-framework.org}}.

Django REST Framework permite crearea rapidă de API-uri REST pentru 
aplicațiile Django. Pentru a îl folosi, în aplicație am creat
câte o clasă de serializare pentru fiecare model 
ce trebuie serializat (\texttt{Account} și \texttt{Expense}).
Aceste clase moștenesc din \texttt{rest\_framework.serializers.ModelSerializer}.
În clasele de serializare specificăm ce câmpuri vrem să fie serializate.
Clasele de serializare pot fi văzute în "authentication/serializers.py"
și "expenses/serializers.py".

În afară de clasele de serializare, am creat și permisiuni pentru fiecare
model. Folosindu-ne de aceste permisiuni, ne asigurăm că un utilizator
nu poate citi datele altui utilizator. Permisiunile se găsesc
în fișierele "permissions.py" din modulele "authentication" și
"expenses".

Având permisiunile și clasele de serializare, folosim clasele
din rest\_framework pentru a customiza mai departe
operațiile pe care le dorim: de exemplu pentru filtrarea 
cheltuielilor după dată, sau pentru a crea un utilizator nou
stocându-i parola în formă hash.

API-ul creat este următorul:
\begin{description}
\item [POST /api/v1/auth/login/] permite logarea unui
utilizator în aplicație. Parametrii primiți sunt
adresa de email a utilizatorului și parola.
\item [POST /api/v1/auth/logout/] deautentifică
utilizatorul curent.
\item [POST /api/v1/accounts/] crează un utilizator nou.
Primește ca parametri numele utilizatorului, parola
și adresa de email.
\item [GET api/v1/expenses/] întoarce lista cu toate
cheltuielile pentru utilizatorul logat în aplicație.
\item [POST /api/v1/expenses/] adaugă o cheltuială
nouă.
\item [DELETE api/v1/expenses/\{:id\}/] șterge cheltuiala
cu id-ul specificat.
\end{description}


\section{Fluxul aplicației}

Fiind o aplicație SPA ce folosește un framework MVC
pe back-end și un alt framework MVC pe front-end,
rutarea URL-urilor are loc la două nivele.

Orice request către aplicație este mai întâi redirecționat
de URL handler-ul Django. În fișierul \texttt{urls.py} sunt
configurate toate rutele aplicației. Indiferent ce pagină
cere utilizatorul, acestuia îi este servit șablonul Django
\texttt{index.html} ce conține întreaga aplicație AngularJS.

A doua rutare are loc la nivelul AngularJS. Serviciul de autentificare
din AngularJS verifică dacă utilizatorul este autentificat sau nu.
Dacă nu este, utilizatorul este redirectat către pagina de autentificare.
Este important să înțelegem că acest redirect se întâmplă
doar prin Ajax. AngularJS este cel care cere șablonul HTML
"login.html" de pe server și îl afișează pe client, fără ca pagina
să fie reîmprospătată.

\section{Autentificarea}

Autentificarea este pe bază de cookie. Pe pagina de autentificare,
AngularJS face POST la endpoint-ul "api/v1/auth/login". Dacă
user-ul și parola se potrivesc, server-ul răspunde cu codul 200 (OK).
În acest caz AngularJS folosește serviciul \$cookies pentru a reține
datele de sesiune primite înapoi de la server. Acestea sunt trimise
până la logout cu fiecare request, astfel serverul știe
că utilizatorul s-a autentificat în aplicație.

\section{Posibilități de îmbunătățire a aplicației}

Datorită limitărilor de timp, există numeroare posibilități de 
îmbunătățire și extindere a aplicației. De exemplu:
\begin{itemize}
\item Adăugare login cu Facebook. Acesta este așteptat de la
majoritatea aplicațiilor din ziua de azi, eliminând necesitatea
utilizatorului de a-și crea un cont pentru fiecare aplicație folosită.
\item Înlocuirea login-ului pe bază de cookie cu un alt mecanism,
de exemplu OAuth. Acest lucru decuplează back-end-ul de front-end, 
astfel API-ul REST ar putea fi folosit
și de aplicații mobile.
\item Îmbunătățirea stilurilor CSS.
\item Filtrarea pe server în loc de client.
\end{itemize}
